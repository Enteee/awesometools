/*      awesomedump.c
*       Ente 
*       ducksource@duckpond.ch
*       Version:1.0
*
*       awesomedump.c
*       Require:
*           - see header
*
*
*       Licence:
*       You're allowed to edit and publish my source in all of your free and open-source projects.
*       Please send me an e-mail if you'll implement this source in one of your commercial or proprietary projects.
*       Leave this Header untouched!
*
*       Warranty:
*       Warranty void if signet is broken
*       =================== / /===================
*       [       Warranty   / /   Signet          ]
*       ==================/ /=====================
*       !!NOWAY!!
*
*/

/*==============================*/
/*             TODO's           */
/*==============================*/
/*
*
*
*
*
*
*/

/*==============================*/
/*           includes           */
/*==============================*/

#include "awesomedump.h"

/*==============================*/
/*         Cool stuff           */
/*==============================*/

/*==============================*/
/*enums declaration + definition*/
/*==============================*/

typedef enum {
	NUM=0,
	X,
	C,
	C_X,
	Dez,
	Dez_C,
	Dez_X,
	Dez_C_X
}format_t;

/*==============================*/
/*     global declarations      */
/*==============================*/

char *format[] = { 
	"%2.2hhx",
	"0x%2.2hhx",
	"\\x%2.2hhx",
	"\\0x%2.2hhx",
	"%03.3hhu",
	"0x%03.3hhu",
	"\\x%03.3hhu",
	"\\0x%03.3hhu",
};

/*==============================*/
/*    function declarations     */
/*==============================*/

/*
*	funcname(args): <desc>
*	Arguments:
*		- <arg1> : <desc1> 
*/

/*
*	usage(): prints usage helptext
*	Arguments:
*/
int usage();

/*==============================*/
/*     function definitions     */
/*==============================*/


int usage(){
	printf("%s",
		AD_PROGNAME" v"AD_VERSION"\n"
		"Read data from stdin and print it out as hexchars\n"
		"\n"
		"Usage:\n"
		"\t"AD_PROGNAME" [OPTIONS]\n"
		"\tPossible [OPTIONS] are:\n"
		"\t-l <linesize>\t\tSet amount of hexnumbers printed per line\n"
		"\t-b <beginning>\t\tAdd <beginning> in front of the whole block\n"
		"\t-e <ending>\t\tAdd <ending> in front of the whole block\n"
		"\t-p <prefix>\t\tAdd <prefix> in front of every line\n"
		"\t-s <sufffix>\t\tAdd <suffix> at the end of evey line\n"
		"\t-d <delimiter>\t\tAdd <delimiter> between hexnumbers\n"
		"\t-x\t\t\tAdd '0x' before hexnumbers\n"
		"\t-c\t\t\tAdd '\\x' before hexnumbers\n"
		"\t-0\t\t\tPrint dezimal instead of hex\n"
		"\t-h\t\t\tPrint this help\n");
	return 0;
}

int main(int argc, char* argv[]){
	unsigned int i;
	int c;
	char *buf;
	unsigned int buf_s;
	unsigned int buf_s_max = AD_BUF_BASESIZE;

	/*Arguments*/
	format_t formattype = NUM;
	int linesize = AD_DEFAULT_LINESIZE;
	char *beginning = NULL;
	char *ending = NULL;
	char *prefix = NULL;
	char *suffix = NULL;
	char *delimiter = NULL;

	// read arguments
	while ( (c = getopt(argc, argv, "l:b:e:p:s:d:xc0h")) != -1) {
		switch (c){
			case 'l':
				linesize = atoi(optarg);
				if(linesize <= 0){
					usage();
					return -1;
				}
			break;
			case 'b':
				beginning = optarg;
			break;
			case 'e':
				ending = optarg;
			break;
			case 'p':
				prefix = optarg;
			break;
			case 's':
				suffix = optarg;
			break;
			case 'd':
				delimiter = optarg;
			break;
			case 'x':
				formattype |= X;
			break;
			case 'c':
				formattype |= C;
			break;
			case '0':
				formattype |= Dez;
			break;
			case 'h':
				usage();
				return 0;
			break;
			default:
				usage();
				return -1;
			break;
		}
	}

	buf = malloc(buf_s_max*sizeof(char));

	// read into buffer until EOF
	for (i=0; (c = fgetc(stdin)) != EOF; i++) {
		if(i >= buf_s_max){ // buffer full?
			buf_s_max *= AD_BUF_INCFACTOR;
			buf = realloc((void *)buf,buf_s_max*sizeof(char));
			memset(&buf[i],0x0,buf_s_max-(i+1));
		}
		buf[i] = (char)c; //save char
	}
	buf_s = i; // set bufsize


	// easter egg
	if(memcmp("hexdump",buf,0x7) == 0){
		char egg[] = "\x20\x20\x20\x20\x29\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x29\x20\x20\x28\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2a\x20\x20\x20\x20\x20"
"\x28\x20\x20\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x28\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x0a"
"\x20\x28\x20\x2f\x28\x20\x20\x20\x20\x20\x20\x20\x28\x20\x2f\x28\x20\x20\x29\x5c\x20\x29\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x28\x20\x20\x60\x20\x20\x20\x20"
"\x29\x5c\x20\x29\x20\x20\x20\x29\x5c\x20\x29\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x20\x29\x5c\x20\x29\x20\x29\x5c\x20\x29\x20\x20\x29\x5c\x20\x29\x20\x20\x0a"
"\x20\x29\x5c\x28\x29\x29\x20\x28\x20\x20\x20\x20\x29\x5c\x28\x29\x29\x28\x28\x29\x2f\x28\x20\x20\x20\x20\x20\x20\x28\x20\x20\x20\x29\x5c\x29\x29\x28\x20\x20\x28"
"\x28\x29\x2f\x28\x20\x20\x28\x28\x29\x2f\x28\x20\x20\x20\x20\x29\x5c\x20\x20\x20\x20\x28\x28\x29\x2f\x28\x28\x28\x29\x2f\x28\x20\x28\x28\x29\x2f\x28\x20\x20\x0a"
"\x28\x28\x5f\x29\x5c\x20\x20\x29\x5c\x20\x20\x28\x28\x5f\x29\x5c\x20\x20\x2f\x28\x5f\x29\x29\x20\x20\x20\x20\x20\x29\x5c\x20\x28\x28\x5f\x29\x28\x29\x5c\x20\x20"
"\x2f\x28\x5f\x29\x29\x20\x20\x2f\x28\x5f\x29\x29\x28\x28\x28\x28\x5f\x29\x28\x20\x20\x20\x2f\x28\x5f\x29\x29\x2f\x28\x5f\x29\x29\x20\x2f\x28\x5f\x29\x29\x20\x0a"
"\x20\x5f\x28\x28\x5f\x29\x28\x28\x5f\x29\x20\x5f\x5f\x28\x28\x5f\x29\x28\x5f\x29\x29\x5f\x20\x20\x20\x5f\x20\x28\x28\x5f\x29\x28\x5f\x28\x29\x28\x28\x5f\x29\x28"
"\x5f\x29\x29\x20\x20\x20\x28\x5f\x29\x29\x5f\x7c\x20\x29\x5c\x20\x5f\x20\x29\x5c\x20\x28\x5f\x29\x29\x20\x28\x5f\x29\x29\x20\x20\x28\x5f\x29\x29\x20\x20\x20\x0a"
"\x7c\x20\x7c\x7c\x20\x7c\x7c\x20\x5f\x5f\x7c\x5c\x20\x5c\x2f\x20\x2f\x20\x7c\x20\x20\x20\x5c\x20\x7c\x20\x7c\x20\x7c\x20\x7c\x7c\x20\x20\x5c\x2f\x20\x20\x7c\x7c"
"\x20\x5f\x20\x5c\x20\x20\x7c\x20\x7c\x5f\x20\x20\x20\x28\x5f\x29\x5f\x5c\x28\x5f\x29\x7c\x5f\x20\x5f\x7c\x7c\x20\x7c\x20\x20\x20\x2f\x20\x5f\x5f\x7c\x20\x20\x0a"
"\x7c\x20\x5f\x5f\x20\x7c\x7c\x20\x5f\x7c\x20\x20\x3e\x20\x20\x3c\x20\x20\x7c\x20\x7c\x29\x20\x7c\x7c\x20\x7c\x5f\x7c\x20\x7c\x7c\x20\x7c\x5c\x2f\x7c\x20\x7c\x7c"
"\x20\x20\x5f\x2f\x20\x20\x7c\x20\x5f\x5f\x7c\x20\x20\x20\x2f\x20\x5f\x20\x5c\x20\x20\x20\x7c\x20\x7c\x20\x7c\x20\x7c\x5f\x5f\x20\x5c\x5f\x5f\x20\x5c\x20\x20\x0a"
"\x7c\x5f\x7c\x7c\x5f\x7c\x7c\x5f\x5f\x5f\x7c\x2f\x5f\x2f\x5c\x5f\x5c\x20\x7c\x5f\x5f\x5f\x2f\x20\x20\x5c\x5f\x5f\x5f\x2f\x20\x7c\x5f\x7c\x20\x20\x7c\x5f\x7c\x7c"
"\x5f\x7c\x20\x20\x20\x20\x7c\x5f\x7c\x20\x20\x20\x20\x2f\x5f\x2f\x20\x5c\x5f\x5c\x20\x7c\x5f\x5f\x5f\x7c\x7c\x5f\x5f\x5f\x5f\x7c\x7c\x5f\x5f\x5f\x2f\x0a\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x2d\x2e\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x2f\x20\x20\x3b\x0a\x20\x2e\x2d\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x7c\x0a\x20\x7c\x20\x60\x2e\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x20\x7c\x0a\x20\x3b\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x2c\x2d\x22\x20\x60\x60\x27\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20"
"\x20\x3b\x0a\x20\x3b\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2c\x27\x20\x20\x20\x20\x20\x20\x20\x20\x27\x2e\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x7c\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x7c\x0a\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20\x7c\x20"
"\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x0a\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x7c"
"\x20\x20\x2e\x2d\x2e\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27"
"\x0a\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x3b\x20\x20\x2f\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x0a\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60"
"\x2e\x20\x20\x7c\x20\x7c\x4f\x2c\x5f\x4f\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x7c\x20\x27\x2f\x20\x60\x5c\x20\x20\x20\x2f\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x2e\x27\x2f\x60\x20\x20\x20\x20\x60\x2d\x4c\x2c\x2d\x2d\x2e\x20\x20\x20\x20\x20\x20\x20\x27\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2c\x27\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f"
"\x5f\x5f\x60\x2e\x20\x20\x20\x20\x20\x20\x5c\x2e\x27\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x66\x20\x5c\x20\x20\x20\x20\x2f\x60\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x2f\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20"
"\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x5f\x7c\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x2f\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x28\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x7c\x7c\x20"
"\x2f\x60\x20\x3b\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20"
"\x20\x60\x2d\x2e\x2e\x5f\x5f\x5f\x5f\x2e\x2d\x27\x60\x20\x20\x27\x2f\x7c\x20\x20\x2f\x20\x2c\x27\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
"\x2e\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x2f\x4c\x5f\x5f\x2e\x27\x5f\x2f\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x7c\x20\x20\x20\x20"
"\x7c\x20\x20\x20\x20\x20\x60\x22\x2d\x2d\x27\x60\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x2e\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x2c"
"\x2d\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x7c\x20\x20\x20"
"\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x0a";
		printf("%s\n",egg);
	}


	/*Print IT*/

	if(beginning != NULL){
		printf("%s",beginning);
	}

	for(i=0;i<buf_s;i++){
		unsigned int j;

		if(prefix != NULL){
			printf("%s",prefix);
		}

		for(j=1;j<linesize && i<buf_s;j++,i++){ // start with one because we've to threath the last print a bit special
				printf(format[formattype],(unsigned char)buf[i]);

				if(	(delimiter != NULL)
				&& 	(i+1)<buf_s){ // has still more bytes?
					printf("%s",delimiter);
				}
		}

		if(i<buf_s){ // has still more bytes?
			printf(format[formattype],(unsigned char)buf[i]); // print it
		}

		if(suffix != NULL){
			printf("%s",suffix);
		}

	
		if(	((i+1) >= buf_s)
		&&	(ending != NULL)){ // has more lines?
			printf("%s\n",ending); //print ending
		}else{
			printf("\n");
		}

	}

	free(buf);

	return 1;
}
