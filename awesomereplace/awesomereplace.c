/*      awesomereplace.c
*       Ente
*       ducksource@duckpond.ch
*       Version:1.1
*
*       awesomereplace.c
*       Require:
*           - see header
*
*
*       Licence:
*       You're allowed to edit and publish my source in all of your free and open-source projects.
*       Please send me an e-mail if you'll implement this source in one of your commercial or proprietary projects.
*       Leave this Header untouched!
*
*       Warranty:
*       Warranty void if seal is broken
*       =================== / /===================
*       [       Warranty   / /   seal            ]
*       ==================/ /=====================
*       !!NOWAY!!
*
*/

/*==============================*/
/*             TODO's           */
/*==============================*/
/*
*
*
*
*
*
*/

/*==============================*/
/*           includes           */
/*==============================*/

#include "awesomereplace.h"

/*==============================*/
/*         Cool stuff           */
/*==============================*/

/*==============================*/
/*enums declaration + definition*/
/*==============================*/

/*==============================*/
/*     global declarations      */
/*==============================*/

/*==============================*/
/*    function declarations     */
/*==============================*/

/*
* funcname(args): <desc>
* Arguments:
*   - <arg1> : <desc1> 
*/

/*
* usage(): prints usage helptext
* Arguments:
*/
static int usage();

/*
* egg(buf,buf_s): prints easter egg
* Arguments:
*   - buf   : Buffer to analyze
*   - buf_s : Size of buf
*/
static int egg(char *buf,unsigned int buf_s);


/*
* write_buf(buf,buf_s,buf_pos,write_s): write write_s bytes starting at buf_pos from circular buffer buf
* Arguments:
*   - buf     : Buffer to write
*   - buf_s   : Size of buf
*   - buf_pos : Where to start writing
*   - write_s : amount of bytes to write
*/
static int write_buf(char *buf, unsigned int buf_s, unsigned int buf_pos,unsigned int write_s);

/*==============================*/
/*     function definitions     */
/*==============================*/

static int usage(){
  printf("%s",
    AR_PROGNAME" v"AR_VERSION"\n"
    "Read data from STDIN replace [search] with [replace] and print it to STDOUT\n"
    "\n"
    "Usage:\n"
    "\t"AR_PROGNAME" [search] [replace]\n"
  );
  return 0;
}

static int egg(char *buf,unsigned int buf_s){
  // easter egg
  if(buf_s >= 9 &&
     memcmp("sed fails",buf,0x9) == 0){
    char egg[] ="\x20\x20\x20\x20\x20\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x20\x20\x28\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x28\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x28\x20\x20\x20\x20\x20\x0a\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x29\x5c\x20\x29\x20\x20\x20\x20\x20\x29\x5c\x20\x29\x20\x20\x20\x20\x29\x5c\x20\x29\x20"
                "\x20\x20\x20\x28\x20\x20\x20\x20\x20\x20\x29\x5c\x20\x29\x20\x29\x5c\x20\x29\x20\x20\x29\x5c\x20\x29\x20\x20\x0a\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x28\x28\x29\x2f\x28\x20\x28\x20\x20\x28\x28\x29\x2f\x28\x20\x20\x20\x28\x28\x29\x2f\x28\x20\x20"
                "\x20\x20\x29\x5c\x20\x20\x20\x20\x28\x28\x29\x2f\x28\x28\x28\x29\x2f\x28\x20\x28\x28\x29\x2f\x28\x20\x20\x0a\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x2f\x28\x5f\x29\x29\x29\x5c\x20\x20\x2f\x28\x5f\x29\x29\x20\x20\x20\x2f\x28\x5f\x29\x29\x28\x28"
                "\x28\x28\x5f\x29\x28\x20\x20\x20\x2f\x28\x5f\x29\x29\x2f\x28\x5f\x29\x29\x20\x2f\x28\x5f\x29\x29\x20\x0a\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x28\x5f\x29\x29\x20\x28\x28\x5f\x29\x28\x5f\x29\x29\x5f\x20\x20\x20\x28\x5f\x29\x29\x5f\x7c\x20\x29\x5c"
                "\x20\x5f\x20\x29\x5c\x20\x28\x5f\x29\x29\x20\x28\x5f\x29\x29\x20\x20\x28\x5f\x29\x29\x20\x20\x20\x0a\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x2f\x20\x5f\x5f\x7c\x7c\x20\x5f\x5f\x7c\x7c\x20\x20\x20\x5c\x20\x20\x7c\x20\x7c\x5f\x20\x20\x20\x28\x5f\x29"
                "\x5f\x5c\x28\x5f\x29\x7c\x5f\x20\x5f\x7c\x7c\x20\x7c\x20\x20\x20\x2f\x20\x5f\x5f\x7c\x20\x20\x0a\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x5c\x5f\x5f\x20\x5c\x7c\x20\x5f\x7c\x20\x7c\x20\x7c\x29\x20\x7c\x20\x7c\x20\x5f\x5f\x7c\x20\x20\x20\x2f\x20\x5f"
                "\x20\x5c\x20\x20\x20\x7c\x20\x7c\x20\x7c\x20\x7c\x5f\x5f\x20\x5c\x5f\x5f\x20\x5c\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x7c\x5f\x5f\x5f\x2f\x7c\x5f\x5f\x5f\x7c\x7c\x5f\x5f\x5f\x2f\x20\x20\x7c\x5f\x7c\x20\x20\x20\x20\x2f\x5f\x2f\x20\x5c"
                "\x5f\x5c\x20\x7c\x5f\x5f\x5f\x7c\x7c\x5f\x5f\x5f\x5f\x7c\x7c\x5f\x5f\x5f\x2f\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x2d\x2e\x0a\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x3b\x0a"
                "\x20\x2e\x2d\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f"
                "\x20\x20\x20\x7c\x0a\x20\x7c\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x2e\x27\x20\x20\x20\x20\x7c\x0a\x20\x3b\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x2c\x2d\x22\x20\x60\x60\x27\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x3b\x0a\x20\x3b\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2c\x27\x20\x20\x20\x20\x20\x20\x20\x20\x27\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x7c\x20\x20\x20\x20\x20\x5c\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x7c\x0a\x20\x20\x3b\x20\x20\x20\x20"
                "\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20"
                "\x7c\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x0a"
                "\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x2e\x2d\x2e\x5f\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x2e\x27\x0a\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x3b\x20\x20\x2f\x20\x20\x20"
                "\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x7c\x0a\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x7c\x20\x7c\x4f\x2c"
                "\x5f\x4f\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x7c\x20\x27"
                "\x2f\x20\x60\x5c\x20\x20\x20\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27"
                "\x2f\x60\x20\x20\x20\x20\x60\x2d\x4c\x2c\x2d\x2d\x2e\x20\x20\x20\x20\x20\x20\x20\x27\x20\x20\x20\x2f\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2c"
                "\x27\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x60\x2e\x20\x20\x20\x20\x20\x20\x5c\x2e\x27\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x66\x20\x5c\x20\x20\x20\x20\x2f\x60\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x2f\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x20\x20\x20\x5f\x7c\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x28\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x2e\x27\x7c\x7c\x20\x2f\x60\x20\x3b\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x60\x2d\x2e\x2e\x5f\x5f\x5f"
                "\x5f\x2e\x2d\x27\x60\x20\x20\x27\x2f\x7c\x20\x20\x2f\x20\x2c\x27\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x2e\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20"
                "\x20\x20\x20\x2f\x4c\x5f\x5f\x2e\x27\x5f\x2f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x0a"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x60\x2e\x7c\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x20\x60\x22"
                "\x2d\x2d\x27\x60\x20\x7c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x2e\x27\x0a\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x7c\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x2c\x2d\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x7c\x20\x20\x20\x2e\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20"
                "\x20\x20\x20\x20\x60\x2e\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3b\x20\x20\x20\x20\x7c\x20"
                "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5c\x0a";
    printf("%s\n",egg);
  }
  return 1;
}

static int write_buf(char *buf, unsigned int buf_s, unsigned int buf_pos,unsigned int write_s){
  unsigned int bytes_can_write_at_pos = buf_s - buf_pos;
  if(write_s <= bytes_can_write_at_pos){
    write(STDOUT_FILENO,&(buf[buf_pos]),write_s);
  }else{
    unsigned int bytes_can_write_wrap = write_s - bytes_can_write_at_pos;
    write(STDOUT_FILENO,&(buf[buf_pos]),bytes_can_write_at_pos);
    write(STDOUT_FILENO,buf,bytes_can_write_wrap);
  }
  return 1;
}

int main(int argc, char* argv[]){
  unsigned int i;
  unsigned char c;
  char *buf;  // circular input buffer
  unsigned int buf_read_pos; 
  unsigned int buf_cmp_pos = 0; 
  ssize_t buf_new_bytes;
  ssize_t read_bytes;
  unsigned int buf_s;
  unsigned int *shift_table[AR_SHIFT_TABLE_SIZE];

  // Command line arguments
  unsigned int search_s;
  char *search;
  unsigned int replace_s;
  char *replace;
  
  // check arguments
  if(argc != 3){
    usage();
    return EXIT_FAILURE;
  }
  search    = argv[1];
  search_s  = strlen(search);
  replace   = argv[2];
  replace_s = strlen(replace);
  if(search_s <= 0
    || replace_s <= 0){
    usage();
    return EXIT_FAILURE;
  }

  // initialize the buffer
  buf_s = search_s*AR_BUF_FACTOR;
  buf = malloc(buf_s*sizeof(char));
  read_bytes = read(STDIN_FILENO,buf,buf_s);
  buf_new_bytes = read_bytes;
  buf_read_pos = read_bytes % buf_s;
  // easter egg..
  egg(buf,buf_s);

  // initialize shift table
  for(i=0;i < AR_SHIFT_TABLE_SIZE;i++){
    unsigned int j;
    shift_table[i] = malloc(search_s*sizeof(unsigned int));
    // initialize with shift numbers
    for(j=0;j < search_s;j++){
      shift_table[i][j] = j+1;
    }
  }

  // analyze pattern (fill shift table)
  for(i=search_s-1;(i+1) > 0;i--){
    unsigned int j;
    c = search[i]; 
    // fill shift_table from left to right with ints ascending until 0 or end
    for(j=i;j < search_s && shift_table[c][j] != 0;j++){
      shift_table[c][j] = j-i;
    }
  }

  // does the search pattern fit in the buffer to analyze?
  i = search_s-1; // count matching
  while(search_s <= buf_new_bytes){
    c = buf[(buf_cmp_pos+i) % buf_s];
    // search pattern backwards
    unsigned int shift = shift_table[c][i];
    if( shift == 0 && i == 0){
      // complete match:
      // write replace string
      write(STDOUT_FILENO,replace,replace_s);
      // continue searching behind match...
      shift = search_s;
    }else if(shift == 0){
      // match:
      // dec i
      i--;
    }else{
      // no match:
      // write bytes behind pattern (shifted bytes)
      write_buf(buf,buf_s,buf_cmp_pos,shift);
    }

    if(shift != 0){
      // shift to new cmp position
      buf_cmp_pos = (buf_cmp_pos + shift) % buf_s;
      buf_new_bytes -= shift;
      // reset search position
      i = search_s - 1;
      // enough bytes in buffer left for next comparison?
      if(buf_new_bytes < search_s){
        unsigned int bytes_to_read = buf_s - buf_new_bytes;
        unsigned int bytes_can_read_at_pos = buf_s - buf_read_pos;
        read_bytes = 0;
        // enough space without wraparound?
        if(bytes_to_read <= bytes_can_read_at_pos){
          read_bytes += read(STDIN_FILENO,&(buf[buf_read_pos]),bytes_to_read);
        }else{
          // no: wrap
          unsigned int bytes_can_read_wrap = bytes_to_read - bytes_can_read_at_pos;
          read_bytes += read(STDIN_FILENO,&(buf[buf_read_pos]),bytes_can_read_at_pos);
          read_bytes += read(STDIN_FILENO,buf,bytes_can_read_wrap);
        }

        buf_read_pos = (buf_read_pos + read_bytes) % buf_s;
        buf_new_bytes += read_bytes;
      }
    }
  }

  // write remaining buffer
  write_buf(buf,buf_s,buf_cmp_pos,buf_new_bytes);

  // frees
  for(i=0;i < AR_SHIFT_TABLE_SIZE;i++){
    free(shift_table[i]);
  }
  free(buf);

  return EXIT_SUCCESS;
}

